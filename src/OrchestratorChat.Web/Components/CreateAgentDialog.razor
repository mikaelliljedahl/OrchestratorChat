@namespace OrchestratorChat.Web.Components
@inherits ComponentBase

<MudDialog Visible="@IsVisible" VisibleChanged="@OnVisibilityChanged">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Add" Class="mr-3" />
            Create New Agent
        </MudText>
    </TitleContent>
    
    <DialogContent>
        <MudGrid>
            <MudItem xs="12">
                <MudTextField @bind-Value="_agentName" 
                             Label="Agent Name" 
                             Variant="Variant.Outlined" 
                             Required="true" 
                             Error="@(!string.IsNullOrEmpty(_nameError))" 
                             ErrorText="@_nameError" />
            </MudItem>
            
            <MudItem xs="12">
                <MudSelect @bind-Value="_selectedType" 
                          Label="Agent Type" 
                          Variant="Variant.Outlined" 
                          Required="true">
                    <MudSelectItem Value="AgentType.Claude">Claude</MudSelectItem>
                    <MudSelectItem Value="AgentType.Saturn">Saturn</MudSelectItem>
                </MudSelect>
            </MudItem>
            
            <MudItem xs="12">
                <MudTextField @bind-Value="_workingDirectory" 
                             Label="Working Directory" 
                             Variant="Variant.Outlined" 
                             Placeholder="@Environment.CurrentDirectory" />
            </MudItem>
            
            <MudItem xs="12">
                <MudSelect @bind-Value="_selectedModel" 
                          Label="Model" 
                          Variant="Variant.Outlined">
                    @if (_selectedType == AgentType.Claude)
                    {
                        <MudSelectItem Value="@("claude-sonnet-4-20250514")">Claude Sonnet 4</MudSelectItem>
                        <MudSelectItem Value="@("claude-3-5-sonnet-20241022")">Claude 4.1 Opus</MudSelectItem>
                    }
                    else if (_selectedType == AgentType.Saturn)
                    {
                        <MudSelectItem Value="@("claude-sonnet-4-20250514")">Claude Sonnet 4</MudSelectItem>
                        <MudSelectItem Value="@("claude-3-5-sonnet-20241022")">Claude 4.1 Opus</MudSelectItem>
                        <MudSelectItem Value="@("gpt-5")">GPT-5</MudSelectItem>
                        <MudSelectItem Value="@("gpt-5-mini")">GPT-5 Mini</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            
            @if (_selectedType == AgentType.Saturn)
            {
                <MudItem xs="12">
                    <MudSelect T="string" 
                              Value="_selectedProvider" 
                              ValueChanged="OnProviderChanged"
                              Label="Provider" 
                              Variant="Variant.Outlined">
                        <MudSelectItem Value="@("OpenRouter")">OpenRouter (API Key)</MudSelectItem>
                        <MudSelectItem Value="@("Anthropic")">Anthropic (OAuth)</MudSelectItem>
                    </MudSelect>
                </MudItem>
                
                @if (_selectedProvider == "Anthropic")
                {
                    <MudItem xs="12">
                        <MudPaper Class="pa-3" Outlined="true">
                            <MudText Typo="Typo.subtitle2" Class="mb-2">Anthropic OAuth Authentication</MudText>
                            
                            @if (_anthropicOAuthStatus?.Connected == true)
                            {
                                <MudAlert Severity="Severity.Success" Class="mb-2">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <span>Connected to Anthropic</span>
                                        <MudButton Color="Color.Error" 
                                                  Variant="Variant.Text" 
                                                  Size="Size.Small" 
                                                  OnClick="DisconnectAnthropicOAuth">
                                            Disconnect
                                        </MudButton>
                                    </div>
                                </MudAlert>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Warning" Class="mb-2">
                                    Not connected to Anthropic.
                                </MudAlert>
                                
                                <div class="d-flex gap-2 mb-2">
                                    @if (string.IsNullOrEmpty(_authorizationUrl))
                                    {
                                        <MudButton Color="Color.Primary" 
                                                  Variant="Variant.Filled" 
                                                  OnClick="GetAnthropicOAuthUrl"
                                                  Disabled="@_oauthInProgress">
                                            @if (_oauthInProgress)
                                            {
                                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                                <MudText>Loading...</MudText>
                                            }
                                            else
                                            {
                                                <MudText>Connect to Anthropic</MudText>
                                            }
                                        </MudButton>
                                    }
                                    else
                                    {
                                        <MudButton Color="Color.Primary" 
                                                  Variant="Variant.Filled"
                                                  Href="@_authorizationUrl"
                                                  Target="_blank"
                                                  OnClick="@(() => _showCodeInput = true)">
                                            <MudText>Connect to Anthropic</MudText>
                                        </MudButton>
                                    }
                                    
                                    <MudButton Color="Color.Secondary" 
                                              Variant="Variant.Outlined" 
                                              OnClick="CheckAnthropicOAuthStatus">
                                        <MudIcon Icon="@Icons.Material.Filled.Refresh" Class="mr-1" />
                                        <MudText>Check Status</MudText>
                                    </MudButton>
                                </div>
                                
                                @if (_showCodeInput)
                                {
                                    <MudPaper Class="pa-3 mt-3" Elevation="0" Outlined="true">
                                        <MudText Typo="Typo.subtitle2" Class="mb-2">Step 2: Enter Authorization Code</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">
                                            After authorizing in Anthropic, copy the authorization code and paste it here:
                                        </MudText>
                                        <MudTextField @bind-Value="_authorizationCode" 
                                                      Label="Authorization Code" 
                                                      Variant="Variant.Outlined"
                                                      Placeholder="Paste the code from Anthropic here"
                                                      Class="mb-2" />
                                        <MudButton Color="Color.Primary" 
                                                  Variant="Variant.Filled"
                                                  OnClick="@SubmitAuthorizationCode"
                                                  Disabled="@(string.IsNullOrWhiteSpace(_authorizationCode) || _oauthInProgress)">
                                            @if (_oauthInProgress)
                                            {
                                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                                <MudText>Submitting...</MudText>
                                            }
                                            else
                                            {
                                                <MudText>Submit Code</MudText>
                                            }
                                        </MudButton>
                                    </MudPaper>
                                }
                                else
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
                                        Note: You can create the agent without connecting. It will require OAuth setup before first use.
                                    </MudText>
                                }
                            }
                        </MudPaper>
                    </MudItem>
                }
            }
            else if (_selectedType == AgentType.Claude)
            {
                <MudItem xs="12">
                    <MudAlert Severity="Severity.Info">
                        Claude agents use the locally installed Claude CLI. Make sure you have Claude CLI installed and authenticated.
                    </MudAlert>
                </MudItem>
            }
            
            <MudItem xs="12">
                <MudTextField @bind-Value="_systemPrompt" 
                             Label="System Prompt" 
                             Variant="Variant.Outlined" 
                             Lines="3" 
                             Placeholder="Optional system prompt for the agent..." />
            </MudItem>
            
            <MudItem xs="6">
                <MudNumericField @bind-Value="_temperature" 
                                Label="Temperature" 
                                Variant="Variant.Outlined" 
                                Min="0.0" 
                                Max="2.0" 
                                Step="0.1" />
            </MudItem>
            
            <MudItem xs="6">
                <MudNumericField @bind-Value="_maxTokens" 
                                Label="Max Tokens" 
                                Variant="Variant.Outlined" 
                                Min="100" 
                                Max="8000" 
                                Step="100" />
            </MudItem>
            
            <MudItem xs="12">
                <MudCheckBox @bind-Value="_requireApproval" 
                            Label="Require approval for tool execution" />
            </MudItem>
        </MudGrid>
    </DialogContent>
    
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                  Variant="Variant.Filled" 
                  OnClick="CreateAgent" 
                  Disabled="@_isCreating">
            @if (_isCreating)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">Creating...</MudText>
            }
            else
            {
                <MudText>Create Agent</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>